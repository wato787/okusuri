# 旧環境分析結果

## 📋 概要

このドキュメントは、Okusuri アプリケーションの現行環境（移行前）の詳細分析結果をまとめたものです。移行計画の第 1 段階「現行環境の棚卸し」の成果物として作成されました。

## 🏗️ アーキテクチャ概要

### 全体構成

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Frontend      │    │    Backend      │    │   Database      │
│  (Next.js 15)   │◄──►│   (Go + Gin)    │◄──►│  (PostgreSQL)   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│      V2         │    │   Notification  │    │   WebPush       │
│ (Vite + React)  │    │   (Custom)      │    │   (VAPID)       │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 技術スタック詳細

#### バックエンド

- **言語**: Go 1.24
- **フレームワーク**: Gin v1.10.0
- **ORM**: GORM v1.25.12
- **データベース**: PostgreSQL
- **認証**: JWT + カスタムセッション管理
- **通知**: WebPush + カスタム通知システム

#### フロントエンド

- **Next.js**: v15.3.0
- **認証**: better-auth + Google OAuth
- **UI**: Radix UI + Tailwind CSS
- **データベース**: 直接 PostgreSQL 接続（pg）

#### V2

- **フレームワーク**: Vite + React 19
- **認証**: better-auth
- **UI**: Radix UI + Tailwind CSS
- **PWA**: Vite PWA Plugin

## 🗄️ データベース設計

### テーブル構造

#### 1. ユーザー管理テーブル

##### `user` テーブル

```sql
CREATE TABLE "user" (
  "id" VARCHAR PRIMARY KEY,
  "name" VARCHAR,
  "email" VARCHAR UNIQUE,
  "emailVerified" BOOLEAN,
  "image" VARCHAR,
  "createdAt" TIMESTAMP,
  "updatedAt" TIMESTAMP
);
```

##### `session` テーブル

```sql
CREATE TABLE "session" (
  "id" VARCHAR PRIMARY KEY,
  "expiresAt" TIMESTAMP,
  "token" VARCHAR UNIQUE,
  "createdAt" TIMESTAMP,
  "updatedAt" TIMESTAMP,
  "ipAddress" VARCHAR,
  "userAgent" VARCHAR,
  "userId" VARCHAR
);
```

##### `account` テーブル

```sql
CREATE TABLE "account" (
  "id" VARCHAR PRIMARY KEY,
  "accountId" VARCHAR,
  "providerId" VARCHAR,
  "userId" VARCHAR,
  "accessToken" VARCHAR,
  "refreshToken" VARCHAR,
  "idToken" VARCHAR,
  "accessTokenExpiresAt" TIMESTAMP,
  "refreshTokenExpiresAt" TIMESTAMP,
  "scope" VARCHAR,
  "password" VARCHAR,
  "createdAt" TIMESTAMP,
  "updatedAt" TIMESTAMP
);
```

#### 2. アプリケーション機能テーブル

##### `medication_log` テーブル

```sql
CREATE TABLE "medication_log" (
  "id" SERIAL PRIMARY KEY,
  "createdAt" TIMESTAMP,
  "updatedAt" TIMESTAMP,
  "deletedAt" TIMESTAMP,
  "userId" VARCHAR NOT NULL,
  "hasBleeding" BOOLEAN DEFAULT false
);
```

##### `notification_setting` テーブル

```sql
CREATE TABLE "notification_setting" (
  "id" SERIAL PRIMARY KEY,
  "createdAt" TIMESTAMP,
  "updatedAt" TIMESTAMP,
  "deletedAt" TIMESTAMP,
  "userId" VARCHAR NOT NULL,
  "platform" VARCHAR NOT NULL,
  "isEnabled" BOOLEAN DEFAULT true,
  "subscription" TEXT,
  UNIQUE("userId", "platform")
);
```

##### `verification` テーブル

```sql
CREATE TABLE "verification" (
  "id" VARCHAR PRIMARY KEY,
  "identifier" VARCHAR,
  "value" VARCHAR,
  "expiresAt" TIMESTAMP,
  "createdAt" TIMESTAMP,
  "updatedAt" TIMESTAMP
);
```

### インデックス設計

#### 主要インデックス

- `user.email`: UNIQUE 制約
- `session.token`: UNIQUE 制約
- `notification_setting.userId, platform`: 複合 UNIQUE インデックス
- `medication_log.userId`: 単一インデックス
- 各テーブルの`deletedAt`: ソフトデリート用インデックス

#### リレーション

- `session.userId` → `user.id`
- `account.userId` → `user.id`
- `medication_log.userId` → `user.id`
- `notification_setting.userId` → `user.id`

## 🔌 API 設計

### エンドポイント一覧

#### 認証関連

| メソッド | パス                        | 認証 | 説明                      |
| -------- | --------------------------- | ---- | ------------------------- |
| GET      | `/api/auth/google`          | 不要 | Google OAuth 認証開始     |
| GET      | `/api/auth/callback/google` | 不要 | Google OAuth コールバック |
| GET      | `/api/auth/session`         | 不要 | セッション情報取得        |
| POST     | `/api/auth/signout`         | 不要 | サインアウト              |

#### 通知関連

| メソッド | パス                        | 認証 | 説明         |
| -------- | --------------------------- | ---- | ------------ |
| POST     | `/api/notification`         | 不要 | 通知送信     |
| GET      | `/api/notification/setting` | 必要 | 通知設定取得 |
| POST     | `/api/notification/setting` | 必要 | 通知設定登録 |

#### 服用履歴関連

| メソッド | パス                      | 認証 | 説明               |
| -------- | ------------------------- | ---- | ------------------ |
| GET      | `/api/medication-status`  | 必要 | 服用状態取得       |
| POST     | `/api/medication-log`     | 必要 | 服用履歴登録       |
| GET      | `/api/medication-log`     | 必要 | 服用履歴一覧取得   |
| GET      | `/api/medication-log/:id` | 必要 | 特定の服用履歴取得 |
| PATCH    | `/api/medication-log/:id` | 必要 | 服用履歴更新       |

#### システム関連

| メソッド | パス          | 認証 | 説明           |
| -------- | ------------- | ---- | -------------- |
| GET      | `/api/health` | 不要 | ヘルスチェック |

### 認証フロー

#### Google OAuth 認証フロー

```
1. フロントエンド: /api/auth/google にリダイレクト
2. Google: ユーザー認証
3. Google: /api/auth/callback/google に認証コード送信
4. バックエンド: 認証コードをアクセストークンに交換
5. バックエンド: Googleからユーザー情報取得
6. バックエンド: ユーザー作成/更新
7. バックエンド: セッション作成
8. フロントエンド: セッション情報をCookieに保存
```

#### セッション管理

- **トークン**: JWT 形式
- **保存場所**: PostgreSQL の`session`テーブル
- **有効期限**: 設定可能（デフォルト 7 日）
- **セキュリティ**: IP アドレス・ユーザーエージェント記録

## 🔔 通知システム

### 通知の種類

1. **WebPush 通知**: ブラウザベース
2. **スケジュール通知**: 定期的な服用リマインダー

### 通知設定

- **プラットフォーム別管理**: Web、モバイル等
- **ユーザー別設定**: 通知 ON/OFF
- **サブスクリプション管理**: WebPush 用

### 通知処理フロー

```
1. EventBridge Scheduler → Lambda起動
2. Lambda: ユーザー一覧取得
3. Lambda: 通知設定取得
4. Lambda: 通知対象者フィルタリング
5. Lambda: WebPush送信
6. CloudWatch: ログ記録
```

## 🚀 CI/CD・デプロイ

### 現在の状況

- **バックエンド**: GitHub Actions（Go CI のみ）
- **フロントエンド**: CI/CD 未設定
- **デプロイ**: 手動/ローカル環境

### GitHub Actions 設定

#### バックエンド CI

```yaml
name: Go CI
on: [push, pull_request]
jobs:
  lint:
    - Go 1.24.2セットアップ
    - golangci-lint実行
    - gofmtチェック
  build:
    - 依存関係整理
    - ビルド実行
```

#### 通知処理

```yaml
name: Notification
on:
  schedule:
    - cron: '0 9 * * *' # 毎日9:00
```

## ⚠️ 移行時の注意点

### 高リスク項目

#### 1. 認証システム移行

- **現行**: カスタム JWT + セッション管理
- **移行先**: AWS Cognito
- **影響度**: 🔴 高
- **変更箇所**: フロントエンド・バックエンド両方

#### 2. データベース移行

- **現行**: PostgreSQL + GORM
- **移行先**: DynamoDB
- **影響度**: 🔴 高
- **変更箇所**: スキーマ設計・クエリ・ORM

#### 3. 通知システム移行

- **現行**: WebPush + カスタム通知
- **移行先**: EventBridge + Lambda
- **影響度**: 🟡 中
- **変更箇所**: 通知処理・スケジューリング

### 中リスク項目

#### 4. インフラ移行

- **現行**: 手動管理
- **移行先**: Terraform
- **影響度**: 🟡 中
- **変更箇所**: インフラ設定・デプロイ

### 低リスク項目

#### 5. フロントエンド移行

- **現行**: ローカル開発環境
- **移行先**: Vercel
- **影響度**: 🟢 低
- **変更箇所**: API エンドポイント・環境変数

## 📊 移行複雑度評価

| 項目           | 複雑度 | 理由                           |
| -------------- | ------ | ------------------------------ |
| 認証           | 🔴 高  | Cognito への完全移行が必要     |
| データベース   | 🔴 高  | PostgreSQL→DynamoDB の大幅変更 |
| 通知           | 🟡 中  | EventBridge + Lambda 化        |
| インフラ       | 🟡 中  | Terraform 化                   |
| フロントエンド | 🟢 低  | API エンドポイント変更のみ     |

## 🔍 詳細調査が必要な項目

### 1. データ量・パフォーマンス

- 現在のユーザー数
- データベースサイズ
- API 応答時間

### 2. 外部連携

- Google OAuth 設定詳細
- WebPush 設定詳細
- その他の外部サービス

### 3. セキュリティ要件

- データ暗号化要件
- アクセス制御要件
- 監査ログ要件

## 📝 次のステップ

1. **DynamoDB スキーマ設計**
2. **Cognito 設定の詳細設計**
3. **Lambda 化のための Go コード修正**
4. **Terraform モジュールの作成**

---

_このドキュメントは移行計画の第 1 段階「現行環境の棚卸し」の成果物です。_
_作成日: 2025 年 8 月 30 日_
_更新日: 2025 年 8 月 30 日_
